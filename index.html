
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Viajes y Guardias</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #34495e;
            border-bottom: 3px solid #2980b9;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: #2980b9;
        }

        .nav-tab.active {
            background: #2980b9;
            font-weight: bold;
        }

        .screen {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .screen.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            margin-top: 10px;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .no-data {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary-card h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .summary-card p {
            font-size: 1.1em;
            margin: 5px 0;
        }

        .backup-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            border: 2px dashed #bdc3c7;
        }

        .backup-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-backup {
            flex: 1;
            min-width: 200px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn-backup:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-restore {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }

        .btn-restore:hover {
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .backup-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöå Gesti√≥n de Viajes y Guardias</h1>
            <div class="subtitle">Sistema de control de operaciones de transporte</div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showScreen('mainScreen')">üè† Inicio</button>
            <button class="nav-tab" onclick="showScreen('travelScreen')">üöó Viajes</button>
            <button class="nav-tab" onclick="showScreen('guardScreen')">üõ°Ô∏è Guardias</button>
            <button class="nav-tab" onclick="showScreen('backupScreen')">üíæ Backup</button>
        </nav>

        <!-- PANTALLA PRINCIPAL -->
        <div id="mainScreen" class="screen active">
            <h2>üìä Resumen General</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>üìà Viajes</h3>
                    <p>Total: <span id="totalTravels">0</span></p>
                    <p>Kil√≥metros: <span id="totalKm">0</span></p>
                    <p>Vi√°ticos: <span id="totalViaticos">0</span></p>
                </div>
                <div class="summary-card">
                    <h3>üõ°Ô∏è Guardias</h3>
                    <p>Total: <span id="totalGuards">0</span></p>
                    <p>Horas: <span id="totalGuardHours">0</span></p>
                </div>
                <div class="summary-card">
                    <h3>üìÖ Hoy</h3>
                    <p id="todayDate">Cargando...</p>
                    <p>Viajes hoy: <span id="todayTravels">0</span></p>
                </div>
            </div>

            <div class="table-container">
                <h3>üìã √öltimos Viajes</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>N¬∞ Orden</th>
                            <th>Origen - Destino</th>
                            <th>KM</th>
                            <th>Horario</th>
                            <th>Vi√°tico</th>
                        </tr>
                    </thead>
                    <tbody id="recentTravels">
                        <tr><td colspan="6" class="no-data">No hay viajes recientes</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PANTALLA DE VIAJES -->
        <div id="travelScreen" class="screen">
            <h2>üöó Gesti√≥n de Viajes</h2>
            
            <form id="travelForm" onsubmit="addTravel(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderNumber">N√∫mero de Orden *</label>
                        <input type="text" id="orderNumber" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="origin">Origen *</label>
                        <input type="text" id="origin" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="destination">Destino *</label>
                        <input type="text" id="destination" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="km">Kil√≥metros *</label>
                        <input type="number" id="km" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="travelType">Tipo de Viaje</label>
                        <select id="travelType">
                            <option value="normal">Normal</option>
                            <option value="especial">Especial</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaViaje">Fecha del Viaje</label>
                        <input type="date" id="fechaViaje">
                    </div>
                    
                    <div class="form-group">
                        <label for="departureTime">Hora de Salida *</label>
                        <input type="time" id="departureTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="arrivalTime">Hora de Llegada *</label>
                        <input type="time" id="arrivalTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="turnoSeleccionado">Turno/Plantilla</label>
                        <select id="turnoSeleccionado">
                            <option value="manual">Manual</option>
                            <option value="directo">Directo (+30km)</option>
                            <option value="normal">Normal</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">‚úÖ Agregar Viaje</button>
            </form>

            <div class="table-container">
                <h3>üìã Lista de Viajes</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>N¬∞ Orden</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>KM</th>
                            <th>Horario</th>
                            <th>Vi√°tico</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="travelList">
                        <!-- Los viajes se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PANTALLA DE GUARDIAS -->
        <div id="guardScreen" class="screen">
            <h2>üõ°Ô∏è Gesti√≥n de Guardias</h2>
            
            <form id="guardForm" onsubmit="addGuard(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="guardOrderNumber">N√∫mero de Orden *</label>
                        <input type="text" id="guardOrderNumber" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="guardDriverName">Nombre del Conductor *</label>
                        <input type="text" id="guardDriverName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="guardStartTime">Hora de Inicio *</label>
                        <input type="time" id="guardStartTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="guardEndTime">Hora de Fin *</label>
                        <input type="time" id="guardEndTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="guardType">Tipo de Guardia</label>
                        <select id="guardType">
                            <option value="diurna">Diurna</option>
                            <option value="nocturna">Nocturna</option>
                            <option value="mixta">Mixta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="guardFecha">Fecha de Guardia</label>
                        <input type="date" id="guardFecha">
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">‚úÖ Agregar Guardia</button>
            </form>

            <div class="table-container">
                <h3>üìã Lista de Guardias</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>N¬∞ Orden</th>
                            <th>Conductor</th>
                            <th>Horario</th>
                            <th>Horas</th>
                            <th>Tipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="guardList">
                        <!-- Las guardias se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PANTALLA DE BACKUP -->
        <div id="backupScreen" class="screen">
            <h2>üíæ Copias de Seguridad</h2>
            
            <div class="backup-section">
                <h3>üì• Exportar Datos</h3>
                <p>Descarga todos los datos en formato JSON para realizar copias de seguridad.</p>
                <div class="backup-buttons">
                    <button class="btn-backup" onclick="exportData()">üì• Exportar Todos los Datos</button>
                    <button class="btn-backup" onclick="exportTravels()">üöó Exportar Solo Viajes</button>
                    <button class="btn-backup" onclick="exportGuards()">üõ°Ô∏è Exportar Solo Guardias</button>
                </div>
            </div>

            <div class="backup-section">
                <h3>üì§ Importar Datos</h3>
                <p>Restaura los datos desde un archivo JSON previamente exportado.</p>
                <div class="backup-buttons">
                    <input type="file" id="backupFile" accept=".json" style="display: none;">
                    <button class="btn-backup btn-restore" onclick="document.getElementById('backupFile').click()">
                        üì§ Seleccionar Archivo de Backup
                    </button>
                    <button class="btn-backup btn-restore" onclick="importData()">
                        üîÑ Restaurar Datos
                    </button>
                </div>
                <p id="importStatus" style="margin-top: 10px;"></p>
            </div>

            <div class="backup-section">
                <h3>üîÑ Acciones R√°pidas</h3>
                <div class="backup-buttons">
                    <button class="btn-backup" onclick="clearAllData()" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        üóëÔ∏è Limpiar Todos los Datos
                    </button>
                    <button class="btn-backup" onclick="generateSampleData()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        üéØ Generar Datos de Ejemplo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
// VARIABLES GLOBALES
let travels = JSON.parse(localStorage.getItem('bus_travels') || '[]');
let favoriteDestinations = JSON.parse(localStorage.getItem('bus_favorites') || '[]');

// INICIALIZACI√ìN
document.addEventListener('DOMContentLoaded', function() {
    updateSummary();
    updateTravelTable();
    updateGuardList();
    updateRecentTravels();
    updateTodayDate();
    
    // Configurar evento para importar datos
    document.getElementById('backupFile').addEventListener('change', handleFileSelect);
});

// FUNCIONES DE NAVEGACI√ìN
function showScreen(screenId) {
    // Ocultar todas las pantallas
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Remover active de todas las pesta√±as
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar pantalla seleccionada
    document.getElementById(screenId).classList.add('active');
    
    // Activar pesta√±a correspondiente
    event.target.classList.add('active');
    
    // Actualizar datos espec√≠ficos de cada pantalla
    if (screenId === 'mainScreen') {
        updateRecentTravels();
    } else if (screenId === 'travelScreen') {
        updateTravelTable();
    } else if (screenId === 'guardScreen') {
        updateGuardList();
    }
}

// FUNCIONES DE VIAJES
function addTravel(event) {
    event.preventDefault();
    
    const orderNumber = document.getElementById('orderNumber').value;
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    const km = parseFloat(document.getElementById('km').value);
    const travelType = document.getElementById('travelType').value;
    const departureTime = document.getElementById('departureTime').value;
    const arrivalTime = document.getElementById('arrivalTime').value;
    const fechaInput = document.getElementById('fechaViaje').value;
    
    if (!orderNumber || !origin || !destination || !km || !departureTime || !arrivalTime) {
        alert('Complete todos los campos obligatorios');
        return;
    }
    
    // CALCULAR HORAS TRABAJADAS PRIMERO
    const start = new Date(`2000-01-01T${departureTime}`);
    const end = new Date(`2000-01-01T${arrivalTime}`);
    let hoursWorked = (end - start) / (1000 * 60 * 60);
    if (hoursWorked < 0) hoursWorked += 24;
    
    if (hoursWorked <= 0) {
        alert('La hora de llegada debe ser posterior a la de salida');
        return;
    }
    
    // CALCULAR VI√ÅTICOS POR N√öMERO DE ORDEN
    let horasTotalesOrden = calcularHorasPorOrden(orderNumber);
    console.log(`üïí Orden ${orderNumber}: ${horasTotalesOrden} horas totales`);

    // Si este es el primer viaje del orden, usar sus horas individuales
    const viajesDelOrden = travels.filter(t => t.orderNumber == orderNumber);
    if (viajesDelOrden.length === 0) {
        horasTotalesOrden = hoursWorked;
        console.log(`üìù Primer viaje del orden - horas temporales: ${horasTotalesOrden}`);
    }

    const viaticos = horasTotalesOrden >= 9 ? 1 : 0;
    console.log(`üí∞ Vi√°tico para orden ${orderNumber}: ${viaticos ? 'S√ç' : 'NO'}`);
    
    // CALCULAR ACOPLADOS
    const turnoSeleccionado = document.getElementById('turnoSeleccionado');
    const descripcionTurno = turnoSeleccionado.options[turnoSeleccionado.selectedIndex].text;
    const esDirecto = descripcionTurno.includes('Directo');
    const acoplados = esDirecto ? 1 : 0;
    const kmTotal = esDirecto ? km + 30 : km;
    
    let fechaViaje;
    if (fechaInput) {
        const [a√±o, mes, dia] = fechaInput.split('-');
        fechaViaje = `${dia}/${mes}/${a√±o}`;
    } else {
        fechaViaje = new Date().toLocaleDateString('es-ES');
    }
    
    const travel = {
        id: Date.now(),
        orderNumber, 
        origin, 
        destination, 
        km: kmTotal,
        kmRuta: km,
        acoplados: acoplados,
        type: travelType,
        departureTime, 
        arrivalTime, 
        hoursWorked: hoursWorked.toFixed(2),
        date: fechaViaje,
        viaticos: viaticos,
        timestamp: new Date().toISOString()
    };
    
    travels.push(travel);
    localStorage.setItem('bus_travels', JSON.stringify(travels));
    
    // GUARDAR COMO FAVORITO SI ES MANUAL
    const turnoId = document.getElementById('turnoSeleccionado').value;
    if (turnoId === 'manual') {
        guardarDestinoFavorito(origin, destination, km);
    }
    
    // Limpiar formulario
    document.getElementById('travelForm').reset();
    
    updateSummary();
    updateTravelTable();
    updateRecentTravels();
    
    alert('‚úÖ Viaje agregado! ' + (viaticos ? '(Con vi√°tico)' : '') + 
          (turnoId === 'manual' ? ' ‚≠ê (Guardado como favorito)' : ''));
    showScreen('mainScreen');
}

function calcularHorasPorOrden(orderNumber) {
    const viajesOrden = travels.filter(t => t.orderNumber == orderNumber);
    return viajesOrden.reduce((total, viaje) => total + parseFloat(viaje.hoursWorked || 0), 0);
}

function guardarDestinoFavorito(origin, destination, km) {
    const nuevoFavorito = {
        id: Date.now(),
        origin,
        destination,
        km,
        timestamp: new Date().toISOString()
    };
    
    // Evitar duplicados
    const existe = favoriteDestinations.some(fav => 
        fav.origin === origin && fav.destination === destination
    );
    
    if (!existe) {
        favoriteDestinations.push(nuevoFavorito);
        localStorage.setItem('bus_favorites', JSON.stringify(favoriteDestinations));
    }
}

function updateTravelTable() {
    const travelList = document.getElementById('travelList');
    travelList.innerHTML = '';
    
    if (travels.length === 0) {
        travelList.innerHTML = '<tr><td colspan="8" class="no-data">No hay viajes registrados</td></tr>';
        return;
    }
    
    // Ordenar por fecha m√°s reciente primero
    travels.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    travels.forEach(travel => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${travel.date}</td>
            <td>${travel.orderNumber}</td>
            <td>${travel.origin}</td>
            <td>${travel.destination}</td>
            <td>${travel.km.toFixed(1)}</td>
            <td>${travel.departureTime} - ${travel.arrivalTime}</td>
            <td>${travel.viaticos ? '‚úÖ' : '‚ùå'}</td>
            <td>
                <button class="btn-delete" onclick="deleteTravel(${travel.id})">üóëÔ∏è</button>
            </td>
        `;
        
        travelList.appendChild(row);
    });
}

function deleteTravel(travelId) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar este viaje?')) {
        travels = travels.filter(travel => travel.id !== travelId);
        localStorage.setItem('bus_travels', JSON.stringify(travels));
        updateTravelTable();
        updateSummary();
        updateRecentTravels();
    }
}

// FUNCIONES DE GUARDIAS
function addGuard(event) {
    event.preventDefault();
    
    const orderNumber = document.getElementById('guardOrderNumber').value;
    const driverName = document.getElementById('guardDriverName').value;
    const startTime = document.getElementById('guardStartTime').value;
    const endTime = document.getElementById('guardEndTime').value;
    const guardType = document.getElementById('guardType').value;
    const fechaInput = document.getElementById('guardFecha').value;
    
    if (!orderNumber || !driverName || !startTime || !endTime) {
        alert('Complete todos los campos obligatorios');
        return;
    }
    
    // CALCULAR HORAS
    const start = new Date(`2000-01-01T${startTime}`);
    const end = new Date(`2000-01-01T${endTime}`);
    let hours = (end - start) / (1000 * 60 * 60);
    if (hours < 0) hours += 24;
    
    if (hours <= 0) {
        alert('La hora de finalizaci√≥n debe ser posterior a la de inicio');
        return;
    }
    
    let fechaGuardia;
    if (fechaInput) {
        const [a√±o, mes, dia] = fechaInput.split('-');
        fechaGuardia = `${dia}/${mes}/${a√±o}`;
    } else {
        fechaGuardia = new Date().toLocaleDateString('es-ES');
    }
    
    const guard = {
        id: Date.now(),
        orderNumber,
        driverName,
        startTime,
        endTime,
        hours: hours.toFixed(2),
        type: guardType,
        date: fechaGuardia,
        timestamp: new Date().toISOString()
    };
    
    let savedGuards = JSON.parse(localStorage.getItem('bus_guards') || '[]');
    savedGuards.push(guard);
    localStorage.setItem('bus_guards', JSON.stringify(savedGuards));
    
    // Limpiar formulario
    document.getElementById('guardForm').reset();
    
    updateGuardList();
    updateSummary();
    
    alert('‚úÖ Guardia agregada exitosamente!');
    showScreen('mainScreen');
}

function updateGuardList() {
    const guardList = document.getElementById('guardList');
    guardList.innerHTML = '';
    
    const savedGuards = JSON.parse(localStorage.getItem('bus_guards') || '[]');
    
    if (savedGuards.length === 0) {
        guardList.innerHTML = '<tr><td colspan="7" class="no-data">No hay guardias registrados</td></tr>';
        return;
    }
    
    // Ordenar por fecha m√°s reciente primero
    savedGuards.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    savedGuards.forEach((guard, index) => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${guard.date}</td>
            <td>${guard.orderNumber}</td>
            <td>${guard.driverName}</td>
            <td>${guard.startTime} - ${guard.endTime}</td>
            <td>${guard.hours}</td>
            <td>${guard.type}</td>
            <td>
                <button class="btn-delete" onclick="deleteGuard(${guard.id})">üóëÔ∏è</button>
            </td>
        `;
        
        guardList.appendChild(row);
    });
}

function deleteGuard(guardId) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar esta guardia?')) {
        let savedGuards = JSON.parse(localStorage.getItem('bus_guards') || '[]');
        savedGuards = savedGuards.filter(guard => guard.id !== guardId);
        localStorage.setItem('bus_guards', JSON.stringify(savedGuards));
        updateGuardList();
        updateSummary();
    }
}

// FUNCIONES DE RESUMEN Y UTILIDADES
function updateSummary() {
    const savedTravels = JSON.parse(localStorage.getItem('bus_travels') || '[]');
    const savedGuards = JSON.parse(localStorage.getItem('bus_guards') || '[]');
    
    // C√°lculos para viajes
    const totalTravels = savedTravels.length;
    const totalKm = savedTravels.reduce((sum, travel) => sum + travel.km, 0);
    const totalViaticos = savedTravels.filter(travel => travel.viaticos).length;
    
    // C√°lculos para guardias
    const totalGuards = savedGuards.length;
    const totalGuardHours = savedGuards.reduce((sum, guard) => sum + parseFloat(guard.hours), 0);
    
    // C√°lculos para hoy
    const today = new Date().toLocaleDateString('es-ES');
    const todayTravels = savedTravels.filter(travel => travel.date === today).length;
    
    // Actualizar resumen
    document.getElementById('totalTravels').textContent = totalTravels;
    document.getElementById('totalKm').textContent = totalKm.toFixed(0);
    document.getElementById('totalViaticos').textContent = totalViaticos;
    document.getElementById('totalGuards').textContent = totalGuards;
    document.getElementById('totalGuardHours').textContent = totalGuardHours.toFixed(2);
    document.getElementById('todayTravels').textContent = todayTravels;
}

function updateRecentTravels() {
    const recentTravels = document.getElementById('recentTravels');
    recentTravels.innerHTML = '';
    
    const savedTravels = JSON.parse(localStorage.getItem('bus_travels') || '[]');
    
    if (savedTravels.length === 0) {
        recentTravels.innerHTML = '<tr><td colspan="6" class="no-data">No hay viajes recientes</td></tr>';
        return;
    }
    
    // Ordenar por fecha m√°s reciente y tomar los √∫ltimos 5
    const recent = savedTravels
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 5);
    
    recent.forEach(travel => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${travel.date}</td>
            <td>${travel.orderNumber}</td>
            <td>${travel.origin} ‚Üí ${travel.destination}</td>
            <td>${travel.km.toFixed(1)}</td>
            <td>${travel.departureTime} - ${travel.arrivalTime}</td>
            <td>${travel.viaticos ? '‚úÖ' : '‚ùå'}</td>
        `;
        
        recentTravels.appendChild(row);
    });
}

function updateTodayDate() {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('todayDate').textContent = today.toLocaleDateString('es-ES', options);
}

// FUNCIONES DE BACKUP
function exportData() {
    const data = {
        travels: JSON.parse(localStorage.getItem('bus_travels') || '[]'),
        guards: JSON.parse(localStorage.getItem('bus_guards') || '[]'),
        favorites: JSON.parse(localStorage.getItem('bus_favorites') || '[]'),
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    downloadJSON(data, `backup_completo_${getCurrentDateTime()}.json`);
}

function exportTravels() {
    const travels = JSON.parse(localStorage.getItem('bus_travels') || '[]');
    const data = {
        travels: travels,
        exportDate: new Date().toISOString(),
        total: travels.length
    };
    
    downloadJSON(data, `backup_viajes_${getCurrentDateTime()}.json`);
}

function exportGuards() {
    const guards = JSON.parse(localStorage.getItem('bus_guards') || '[]');
    const data = {
        guards: guards,
        exportDate: new Date().toISOString(),
        total: guards.length
    };
    
    downloadJSON(data, `backup_guardias_${getCurrentDateTime()}.json`);
}

function downloadJSON(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Archivo ${filename} descargado exitosamente`);
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            document.getElementById('backupFile').dataset.importData = e.target.result;
            document.getElementById('importStatus').textContent = `‚úÖ Archivo cargado: ${file.name}`;
            document.getElementById('importStatus').style.color = 'green';
        } catch (error) {
            document.getElementById('importStatus').textContent = '‚ùå Error: Archivo JSON inv√°lido';
            document.getElementById('importStatus').style.color = 'red';
        }
    };
    reader.readAsText(file);
}

function importData() {
    const importData = document.getElementById('backupFile').dataset.importData;
    
    if (!importData) {
        alert('Por favor selecciona un archivo de backup primero');
        return;
    }
    
    try {
        const data = JSON.parse(importData);
        
        if (confirm('¬øEst√°s seguro de que quieres importar estos datos? Se sobrescribir√°n los datos actuales.')) {
            if (data.travels) {
                localStorage.setItem('bus_travels', JSON.stringify(data.travels));
                travels = data.travels;
            }
            
            if (data.guards) {
                localStorage.setItem('bus_guards', JSON.stringify(data.guards));
            }
            
            if (data.favorites) {
                localStorage.setItem('bus_favorites', JSON.stringify(data.favorites));
                favoriteDestinations = data.favorites;
            }
            
            // Actualizar toda la interfaz
            updateSummary();
            updateTravelTable();
            updateGuardList();
            updateRecentTravels();
            
            // Limpiar estado
            document.getElementById('backupFile').value = '';
            document.getElementById('backupFile').dataset.importData = '';
            document.getElementById('importStatus').textContent = '';
            
            alert('‚úÖ Datos importados exitosamente!');
        }
    } catch (error) {
        alert('‚ùå Error al importar datos: ' + error.message);
    }
}

function clearAllData() {
    if (confirm('‚ö†Ô∏è ¬øEST√ÅS ABSOLUTAMENTE SEGURO? Esto eliminar√° TODOS los datos de viajes y guardias. Esta acci√≥n no se puede deshacer.')) {
        localStorage.removeItem('bus_travels');
        localStorage.removeItem('bus_guards');
        localStorage.removeItem('bus_favorites');
        
        travels = [];
        favoriteDestinations = [];
        
        updateSummary();
        updateTravelTable();
        updateGuardList();
        updateRecentTravels();
        
        alert('üóëÔ∏è Todos los datos han sido eliminados');
    }
}

function generateSampleData() {
    if (confirm('¬øGenerar datos de ejemplo? Esto agregar√° viajes y guardias de prueba.')) {
        const sampleTravels = [
            {
                id: Date.now() + 1,
                orderNumber: 'ORD-001',
                origin: 'Dep√≥sito Central',
                destination: 'Planta Norte',
                km: 45.5,
                kmRuta: 45.5,
                acoplados: 0,
                type: 'normal',
                departureTime: '08:00',
                arrivalTime: '09:30',
                hoursWorked: '1.50',
                date: new Date().toLocaleDateString('es-ES'),
                viaticos: 0,
                timestamp: new Date().toISOString()
            },
            {
                id: Date.now() + 2,
                orderNumber: 'ORD-002',
                origin: 'Planta Norte',
                destination: 'Puerto',
                km: 85.0,
                kmRuta: 85.0,
                acoplados: 1,
                type: 'directo',
                departureTime: '10:00',
                arrivalTime: '13:00',
                hoursWorked: '3.00',
                date: new Date().toLocaleDateString('es-ES'),
                viaticos: 1,
                timestamp: new Date().toISOString()
            }
        ];
        
        const sampleGuards = [
            {
                id: Date.now() + 3,
                orderNumber: 'GUARD-001',
                driverName: 'Juan P√©rez',
                startTime: '18:00',
                endTime: '06:00',
                hours: '12.00',
                type: 'nocturna',
                date: new Date().toLocaleDateString('es-ES'),
                timestamp: new Date().toISOString()
            }
        ];
        
        // Agregar datos de ejemplo
        sampleTravels.forEach(travel => travels.push(travel));
        localStorage.setItem('bus_travels', JSON.stringify(travels));
        
        let savedGuards = JSON.parse(localStorage.getItem('bus_guards') || '[]');
        sampleGuards.forEach(guard => savedGuards.push(guard));
        localStorage.setItem('bus_guards', JSON.stringify(savedGuards));
        
        // Actualizar interfaz
        updateSummary();
        updateTravelTable();
        updateGuardList();
        updateRecentTravels();
        
        alert('üéØ Datos de ejemplo generados exitosamente!');
    }
}

function getCurrentDateTime() {
    const now = new Date();
    return now.toISOString().slice(0, 19).replace(/:/g, '-');
}





































































